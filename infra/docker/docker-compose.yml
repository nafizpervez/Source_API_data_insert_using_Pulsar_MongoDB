name: api_integration

services:
  mongo:
    image: mongo:7
    container_name: Mongo
    restart: unless-stopped
    ports:
      - "${MONGO_PORT:-27017}:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: "${MONGO_INITDB_ROOT_USERNAME}"
      MONGO_INITDB_ROOT_PASSWORD: "${MONGO_INITDB_ROOT_PASSWORD}"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet -u $${MONGO_INITDB_ROOT_USERNAME} -p $${MONGO_INITDB_ROOT_PASSWORD} --authenticationDatabase admin --eval \"db.runCommand({ ping: 1 }).ok\" | grep 1 >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 20s

  pulsar:
    image: apachepulsar/pulsar:3.3.1
    container_name: Pulsar-Message-Broker
    restart: unless-stopped
    command: ["bin/pulsar", "standalone"]
    ports:
      - "${PULSAR_BROKER_PORT:-6650}:6650"
      - "${PULSAR_HTTP_PORT:-8080}:8080"
    healthcheck:
      test: ["CMD-SHELL", "bin/pulsar-admin namespaces list public >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 20s
    volumes:
      - pulsar_data:/pulsar/data

  source-ingestor-worker:
    image: dotnet-worker:latest
    container_name: DotNet-Worker
    restart: unless-stopped
    depends_on:
      pulsar:
        condition: service_healthy
      mongo:
        condition: service_healthy
    build:
      context: ../..
      dockerfile: src/SourceIngestor.Worker/Dockerfile
    environment:
      Pulsar__ServiceUrl: "pulsar://pulsar:6650"
      Pulsar__SourceCheckTopic: "persistent://public/default/source-check"
      Pulsar__PostsBatchTopic: "persistent://public/default/posts-batch"
      Pulsar__DlqTopic: "persistent://public/default/source-check-dlq"
      Pulsar__Subscription: "source-ingestor-sub"

      Mongo__ConnectionString: "mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongo:27017/?authSource=admin"
      Mongo__Database: "API_Integration"
      Mongo__Collection: "Source_Data"
      Mongo__ValidatedCollection: "Valid_Data"
      Mongo__InvalidCollection: "Invalid_Data"
      Mongo__TimeZoneId: "${MONGO_TIMEZONE_ID}"

      # If you still use these env vars elsewhere, keep them.
      RETRY_DELAYS_SECONDS: "60,180,540"
      MAX_DELIVERY_ATTEMPTS: "4"
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -v grep | grep -q \"SourceIngestor.Worker\""]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 20s

  dozzle:
    image: amir20/dozzle:latest
    container_name: Dozzle
    ports:
      - "9999:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - TZ="${MONGO_TIMEZONE_ID}"
    restart: unless-stopped

volumes:
  mongo_data:
  pulsar_data: